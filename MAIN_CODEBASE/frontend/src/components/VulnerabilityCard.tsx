import { useState, useRef, useEffect } from "react";
import { SeverityBadge } from "./SeverityBadge";

interface Props {
  vulnerability: {
    id: string;
    type: string;
    severity: string;
    description: string;
  };
  attackerView?: Record<string, any>;
  defenderFixes?: Record<string, any>;
  impactAnalysis?: Record<string, any>;
  aiCodeSuggestions?: Record<string, any>;
}

export const VulnerabilityCard = ({
  vulnerability,
  attackerView = {},
  defenderFixes = {},
  impactAnalysis = {},
  aiCodeSuggestions = {},
}: Props) => {
  const [isExpanded, setIsExpanded] = useState(false);
  const [tab, setTab] = useState<
    "attacker" | "defender" | "impact" | "ai"
  >("attacker");
  const [height, setHeight] = useState<number | undefined>(0);
  const contentRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    setHeight(isExpanded ? contentRef.current?.scrollHeight : 0);
  }, [isExpanded, tab]);

  const vulnId = vulnerability.id;

  return (
    <div className="rounded-xl border border-cyber-slate/30 bg-cyber-dark/40">
      {/* HEADER */}
      <div
        onClick={() => setIsExpanded(!isExpanded)}
        className="p-5 cursor-pointer flex justify-between"
      >
        <div>
          <h3 className="font-bold text-cyber-white">
            {vulnerability.type}
          </h3>
          <p className="text-sm text-cyber-slate">
            {vulnerability.description}
          </p>
        </div>
        <SeverityBadge severity={vulnerability.severity} />
      </div>

      {/* BODY */}
      <div
        style={{ height }}
        className="transition-[height] overflow-hidden"
      >
        <div ref={contentRef} className="p-5 pt-0">
          {/* TABS */}
          <div className="flex gap-2 mb-4">
            {[
              ["attacker", "Attacker View"],
              ["defender", "Defender Fix"],
              ["impact", "Impact"],
              ["ai", "Secure Code (AI)"],
            ].map(([key, label]) => (
              <button
                key={key}
                onClick={() => setTab(key as any)}
                className={`px-3 py-1 text-xs rounded ${
                  tab === key
                    ? "bg-cyber-blue text-white"
                    : "bg-cyber-dark text-cyber-slate"
                }`}
              >
                {label}
              </button>
            ))}
          </div>

          {/* CONTENT */}
          {tab === "attacker" && (
            <pre className="text-xs bg-red-950/30 p-4 rounded">
              {attackerView[vulnId]?.explanation ||
                "No attacker perspective available."}
            </pre>
          )}

          {tab === "defender" && (
            <pre className="text-xs bg-emerald-950/30 p-4 rounded">
              {defenderFixes[vulnId]?.guidance ||
                "No remediation guidance available."}
            </pre>
          )}

          {tab === "impact" && (
            <div className="grid grid-cols-2 gap-4">
              <div className="p-4 bg-cyber-blue/10 rounded">
                <h4 className="text-xs uppercase mb-1">Technical</h4>
                <p className="text-sm">
                  {impactAnalysis[vulnId]?.technical || "N/A"}
                </p>
              </div>
              <div className="p-4 bg-cyber-dark/60 rounded">
                <h4 className="text-xs uppercase mb-1">Business</h4>
                <p className="text-sm">
                  {impactAnalysis[vulnId]?.business || "N/A"}
                </p>
              </div>
            </div>
          )}

          {tab === "ai" && (
            <div className="p-4 bg-cyber-dark/60 rounded">
              <p className="text-xs text-cyber-slate mb-2">
                AI-generated secure coding suggestion (illustrative only)
              </p>
              <p className="text-sm mb-2">
                {aiCodeSuggestions[vulnId]?.guidance ||
                  "No AI suggestion available."}
              </p>
              {aiCodeSuggestions[vulnId]?.snippet && (
                <pre className="text-xs bg-black/40 p-3 rounded">
                  {aiCodeSuggestions[vulnId].snippet}
                </pre>
              )}
            </div>
          )}
        </div>
      </div>
    </div>
  );
};
